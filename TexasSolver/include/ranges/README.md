# Ranges ディレクトリ

## 概要

本ディレクトリには、プレイヤーのハンドレンジ（手札の範囲）を管理するクラスが格納されています。CFR計算において各プレイヤーのハンド分布を追跡するために使用されます。

## ファイル

### PrivateCards.h
プレイヤーのプライベートカード（手札2枚）を表現するクラスです。

**主要機能:**
- 2枚のカードの組み合わせを整数表現で保持
- カードペアの効率的な格納と比較
- ハッシュ可能な設計

**データ構造:**
- 64ビット整数によるカード表現
- ビット演算による高速な重複チェック

**使用例:**
```cpp
PrivateCards hand(card1_int, card2_int);
```

### PrivateCardsManager.h
プライベートカードの組み合わせを管理するクラスです。

**主要機能:**
- 全ての可能なハンド組み合わせの生成
- ボードカードとの重複チェック
- レンジ内のハンド数の計算

**主要メソッド:**
- `getAllCombinations()`: 全組み合わせの取得
- `filterByBoard()`: ボードカードと重複しないハンドのフィルタリング
- `getValidHands()`: 有効なハンドのリスト取得

### RiverRangeManager.h
リバーラウンドにおけるレンジ管理の特殊化クラスです。

**主要機能:**
- リバーでの完成したボードに基づくレンジ管理
- ハンド強度による並べ替え
- 期待値計算の最適化

**特徴:**
- リバーでは全てのコミュニティカードが公開済み
- ハンド強度が確定しているため、効率的な計算が可能
- ショーダウンでの勝率計算の高速化

**主要メソッド:**
- `getRangeOnRiver()`: リバーでの有効レンジ取得
- `sortByStrength()`: ハンド強度による並べ替え
- `getWinningProbability()`: 勝率計算

### RiverCombs.h
リバーラウンドでの組み合わせ計算を行うクラスです。

**主要機能:**
- 5枚のボードカードと2枚の手札から最強の5枚を選択
- 全ての可能なハンド組み合わせのパターン計算
- メモライゼーションによる高速化

## レンジの表現

### レンジ文字列形式

レンジは以下の形式で表現されます:

```
AA,KK,QQ,JJ:0.5,AKs,AKo:0.75
```

**記法:**
- `AA`: ポケットペア（100%の頻度）
- `AKs`: スーテッド（同じスート）
- `AKo`: オフスート（異なるスート）
- `:0.5`: 50%の頻度でプレイ

### 内部表現

内部的には以下のデータ構造で管理:
- `vector<PrivateCards>`: 全てのハンド組み合わせ
- `vector<float>`: 各ハンドの重み（頻度）

## CFRにおける使用

### リーチ確率の計算

各ノードで、プレイヤーが特定のハンドを持っている確率（リーチ確率）を計算:

```
Reach[hand] = InitialWeight[hand] × ActionProb[action1] × ... × ActionProb[actionN]
```

### レンジの更新

各イテレーションで:
1. 初期レンジから開始
2. アクション選択により確率が変化
3. 終端ノードまでリーチ確率を伝播

### メモリ最適化

- ボードカードと重複するハンドは事前に除外
- 同型性（スートの入れ替え）による重複排除
- 稀なハンドの枝刈り（閾値以下の確率）

## パフォーマンスへの影響

### レンジサイズ

- フルレンジ: 1326通り（52枚から2枚選ぶ組み合わせ）
- ボード除外後: 約1200通り（フロップ）
- タイトレンジ: 200-400通り
- ルーズレンジ: 600-800通り

### 計算量

計算量はレンジサイズの積に比例:
```
計算量 ≈ O(|Range1| × |Range2| × TreeSize)
```

レンジを適切に制限することで大幅な高速化が可能です。

## 使用例

```cpp
// レンジの定義
vector<PrivateCards> range1 = parseRange("AA,KK,QQ,AKs");
vector<PrivateCards> range2 = parseRange("88+,A9s+,KTs+");

// ボードカードとの重複除外
PrivateCardsManager pcm(deck);
auto valid_range1 = pcm.filterByBoard(range1, board);

// リバーでの管理
RiverRangeManager rrm;
auto river_range = rrm.getRangeOnRiver(valid_range1, river_board);
```
